<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Harmonizador Visual</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    p.sub {
      margin-top: 0;
      color: #555;
      font-size: 14px;
    }
    .container {
      display: flex;
      gap: 20px;
      margin-top: 15px;
    }
    .col {
      flex: 1;
      background: #fff;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .col h2 {
      margin-top: 0;
      font-size: 18px;
    }
    label {
      font-size: 14px;
    }
    select, input[type="text"] {
      padding: 5px;
      margin: 5px 0;
      width: 100%;
      max-width: 260px;
    }
    button {
      padding: 6px 12px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #bbb;
      background: #fff;
    }
    button.principal {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .imagem-prato {
      text-align: center;
      margin-top: 10px;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border: 1px dashed #ccc;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }
    .imagem-prato img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .nome-prato {
      font-weight: bold;
      font-size: 16px;
    }
    .status {
      font-size: 13px;
      color: #777;
    }
    .lista-vinhos {
      margin-top: 10px;
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 8px;
      background: #fafafa;
    }
    .vinho-item {
      border-bottom: 1px solid #e0e0e0;
      padding: 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .vinho-item:last-child {
      border-bottom: none;
    }
    .vinho-thumb {
      width: 40px;
      height: 60px;
      background: #ddd;
      border-radius: 4px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #666;
      white-space: pre-line;
      text-align: center;
    }
    .vinho-info {
      flex: 1;
      font-size: 13px;
    }
    .vinho-nome {
      font-weight: bold;
    }
    .vinho-preco {
      color: #007bff;
    }
    .rodape {
      margin-top: 15px;
      font-size: 12px;
      color: #777;
    }
  </style>
</head>
<body>
  <h1>Harmonizador Visual</h1>
  <p class="sub">Busca prato coerente com o vinho selecionado; mantém preços e layout.</p>

  <!-- ENTRAR COM VINHO -> SUGERIR NOSSOS PRÓPRIOS VINHOS -->
  <div class="col" style="margin-top:5px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
    <h2>Entrar com VINHO → sugerir VINHOS do catálogo</h2>
    <input type="text" id="vinhoEntrada" placeholder="Digite o nome ou código do vinho">
    <button id="btnBuscarPorVinho" class="principal">Buscar vinho e sugerir outros</button>
    <div id="resultadoVinhoEntrada" class="lista-vinhos" style="margin-top:10px;">
      <div class="status">Digite um vinho e clique em buscar.</div>
    </div>
  </div>

  <div class="container">
    <!-- Lado ESQUERDO: busca de prato e imagem -->
    <div class="col">
      <h2>Prato (TheMealDB – chave pública)</h2>

      <label for="modoBusca">Modo de busca:</label><br>
      <select id="modoBusca">
        <option value="termo">Por termo (ex.: pasta, salmon)</option>
        <option value="categoria">Por categoria (ex.: Beef, Seafood)</option>
      </select><br>

      <label for="termo">Termo ou categoria:</label><br>
      <input type="text" id="termo" placeholder="Ex.: pasta, salmon, beef, seafood">

      <button id="btnBuscar" class="principal">Buscar prato</button>
      <button id="btnAleatorio">Aleatório</button>

      <div class="imagem-prato" id="boxImagem">
        <div class="status" id="statusImagem">Nenhuma imagem carregada<br>Busque um prato para ver a foto aqui</div>
      </div>
    </div>

    <!-- Lado DIREITO: sugestões de vinhos para o prato -->
    <div class="col">
      <h2>Sugestões de vinhos para o prato</h2>
      <p style="font-size:13px;margin-top:0;">
        Vinhos do seu catálogo, ordenados do menor preço para o maior.
      </p>

      <div class="lista-vinhos" id="listaVinhos">
        <div class="status">Pronto. Selecione um prato e os vinhos serão listados aqui.</div>
      </div>
    </div>
  </div>

  <div class="rodape">
    Regras Uvva: ENTRA VINHO → VINHO; ENTRA RECEITA → VINHO; sugestões coerentes e ordenadas por preço; depois podemos ligar carrinho e filtros por região/uva. [file:2]
  </div>

  <script>
    // =============================
    // CATALOGO (exemplo inicial)
    // Depois você gera isso a partir da planilha. [file:3]
    // =============================
    const vinhosCatalogo = [
      {
        cod: "300078",
        nome: "PORTA 6 TTO - ARAGONES, CASTELÃO, TOURIGA NACIONAL",
        regiao: "PORTUGAL - LISBOA",
        uvas: ["Aragonez", "Castelão", "Touriga Nacional"],
        preco: 58.70,
        imagem: "" // ex.: "img/porta6_tinto.jpg"
      },
      {
        cod: "300093",
        nome: "PORTA 6 BCO - FERNÃO PIRES, ARINTO, SAUVIGNON BLANC",
        regiao: "PORTUGAL - LISBOA",
        uvas: ["Fernão Pires", "Arinto", "Sauvignon Blanc"],
        preco: 58.70,
        imagem: ""
      },
      {
        cod: "39",
        nome: "RESERVA DOS AMIGOS REGIONAL TTO - ARAGONES, CASTELÃO, TINTA MIUDA",
        regiao: "PORTUGAL - LISBOA",
        uvas: ["Aragonez", "Castelão", "Tinta Miuda"],
        preco: 52.68,
        imagem: ""
      }
    ];

    const modoBusca = document.getElementById("modoBusca");
    const termoInput = document.getElementById("termo");
    const btnBuscar = document.getElementById("btnBuscar");
    const btnAleatorio = document.getElementById("btnAleatorio");
    const boxImagem = document.getElementById("boxImagem");
    const statusImagem = document.getElementById("statusImagem");
    const listaVinhosEl = document.getElementById("listaVinhos");

    // =============================
    // THEMEALDB – BUSCA PRATO [web:12]
    // =============================
    function buscarPorTermo(termo) {
      const url = "https://www.themealdb.com/api/json/v1/1/search.php?s=" + encodeURIComponent(termo);
      return fetch(url).then(r => r.json());
    }

    function buscarPorCategoria(cat) {
      const url = "https://www.themealdb.com/api/json/v1/1/filter.php?c=" + encodeURIComponent(cat);
      return fetch(url).then(r => r.json());
    }

    function buscarAleatorio() {
      const url = "https://www.themealdb.com/api/json/v1/1/random.php";
      return fetch(url).then(r => r.json());
    }

    function buscarPorId(id) {
      const url = "https://www.themealdb.com/api/json/v1/1/lookup.php?i=" + encodeURIComponent(id);
      return fetch(url).then(r => r.json());
    }

    function limparImagem() {
      boxImagem.innerHTML = "";
      const div = document.createElement("div");
      div.className = "status";
      div.textContent = "Nenhuma imagem carregada";
      boxImagem.appendChild(div);
    }

    function mostrarPrato(meal) {
      boxImagem.innerHTML = "";
      if (!meal) {
        limparImagem();
        listaVinhosEl.innerHTML = '<div class="status">Nenhum prato encontrado.</div>';
        return;
      }

      const img = document.createElement("img");
      img.src = meal.strMealThumb;
      img.alt = meal.strMeal;

      const nome = document.createElement("div");
      nome.className = "nome-prato";
      nome.textContent = meal.strMeal;

      const legenda = document.createElement("div");
      legenda.className = "status";
      legenda.textContent = (meal.strArea || "") + (meal.strCategory ? " · " + meal.strCategory : "");

      boxImagem.appendChild(img);
      boxImagem.appendChild(nome);
      boxImagem.appendChild(legenda);

      sugerirVinhosParaPrato(meal);
    }

    btnBuscar.addEventListener("click", () => {
      const modo = modoBusca.value;
      const termo = (termoInput.value || "").trim();
      if (!termo) {
        alert("Digite um termo ou categoria para buscar.");
        return;
      }

      statusImagem.textContent = "Buscando prato...";
      listaVinhosEl.innerHTML = '<div class="status">Analisando prato para sugerir vinhos...</div>';

      if (modo === "termo") {
        buscarPorTermo(termo)
          .then(dados => {
            const meals = dados.meals || [];
            mostrarPrato(meals[0] || null);
          })
          .catch(() => {
            limparImagem();
            listaVinhosEl.innerHTML = '<div class="status">Erro ao buscar prato.</div>';
          });
      } else {
        buscarPorCategoria(termo)
          .then(dados => {
            const lista = dados.meals || [];
            if (lista.length === 0) {
              mostrarPrato(null);
              return;
            }
            const escolhido = lista[Math.floor(Math.random() * lista.length)];
            return buscarPorId(escolhido.idMeal);
          })
          .then(detalhe => {
            if (!detalhe) return;
            const meals = detalhe.meals || [];
            mostrarPrato(meals[0] || null);
          })
          .catch(() => {
            limparImagem();
            listaVinhosEl.innerHTML = '<div class="status">Erro ao buscar prato.</div>';
          });
      }
    });

    btnAleatorio.addEventListener("click", () => {
      statusImagem.textContent = "Buscando prato aleatório...";
      listaVinhosEl.innerHTML = '<div class="status">Analisando prato para sugerir vinhos...</div>';

      buscarAleatorio()
        .then(dados => {
          const meals = dados.meals || [];
          mostrarPrato(meals[0] || null);
        })
        .catch(() => {
          limparImagem();
          listaVinhosEl.innerHTML = '<div class="status">Erro ao buscar prato aleatório.</div>';
        });
    });

    // =============================
    // SUGESTÃO DE VINHOS PARA O PRATO (ENTRA RECEITA → VINHO) [file:2]
    // =============================
    function sugerirVinhosParaPrato(meal) {
      if (!meal) {
        listaVinhosEl.innerHTML = '<div class="status">Nenhum prato selecionado.</div>';
        return;
      }

      const categoria = (meal.strCategory || "").toLowerCase();
      let tipoPrato = "carne";
      if (categoria.includes("seafood") || categoria.includes("fish")) {
        tipoPrato = "peixe";
      }

      const copia = [...vinhosCatalogo];
      copia.sort((a, b) => a.preco - b.preco); // menor → maior [file:2][file:3]

      renderVinhos(copia, tipoPrato, listaVinhosEl);
    }

    function renderVinhos(lista, tipoPrato, container) {
      container.innerHTML = "";
      if (!lista || lista.length === 0) {
        container.innerHTML = '<div class="status">Nenhum vinho cadastrado.</div>';
        return;
      }

      const infoTopo = document.createElement("div");
      infoTopo.className = "status";
      infoTopo.textContent = "Sugestões de vinhos (tipo de prato detectado: " + tipoPrato + ")";
      container.appendChild(infoTopo);

      lista.forEach(vinho => {
        const item = document.createElement("div");
        item.className = "vinho-item";

        const thumb = document.createElement("div");
        thumb.className = "vinho-thumb";
        thumb.textContent = vinho.imagem ? "" : "sem\nimg";

        if (vinho.imagem) {
          const img = document.createElement("img");
          img.src = vinho.imagem;
          img.alt = vinho.nome;
          img.style.maxWidth = "40px";
          img.style.maxHeight = "60px";
          img.style.borderRadius = "4px";
          thumb.innerHTML = "";
          thumb.appendChild(img);
        }

        const info = document.createElement("div");
        info.className = "vinho-info";
        info.innerHTML = `
          <div class="vinho-nome">${vinho.nome}</div>
          <div>${vinho.regiao}</div>
          <div>Uvas: ${vinho.uvas.join(", ")}</div>
          <div class="vinho-preco">R$ ${vinho.preco.toFixed(2)}</div>
        `;

        item.appendChild(thumb);
        item.appendChild(info);
        container.appendChild(item);
      });
    }

    // =============================
    // ENTRAR COM VINHO → SUGERIR APENAS NOSSOS VINHOS (WINE BRINGING) [file:2]
    // =============================
    const vinhoEntradaInput = document.getElementById("vinhoEntrada");
    const btnBuscarPorVinho = document.getElementById("btnBuscarPorVinho");
    const resultadoVinhoEntrada = document.getElementById("resultadoVinhoEntrada");

    btnBuscarPorVinho.addEventListener("click", () => {
      const termo = (vinhoEntradaInput.value || "").toLowerCase().trim();
      if (!termo) {
        alert("Digite o nome ou código do vinho.");
        return;
      }

      const vinhoBase = vinhosCatalogo.find(v =>
        v.nome.toLowerCase().includes(termo) || v.cod.toLowerCase().includes(termo)
      );

      if (!vinhoBase) {
        resultadoVinhoEntrada.innerHTML = '<div class="status">Vinho não encontrado no catálogo.</div>';
        return;
      }

      const sugeridos = vinhosCatalogo
        .filter(v =>
          v.cod !== vinhoBase.cod &&
          (v.regiao === vinhoBase.regiao || v.uvas.some(u => vinhoBase.uvas.includes(u)))
        )
        .sort((a, b) => a.preco - b.preco); // menor → maior [file:3]

      renderVinhosEntrada(vinhoBase, sugeridos);
    });

    function renderVinhosEntrada(vinhoBase, lista) {
      resultadoVinhoEntrada.innerHTML = "";

      const topo = document.createElement("div");
      topo.className = "status";
      topo.innerHTML = `
        Vinho selecionado: <strong>${vinhoBase.nome}</strong> (${vinhoBase.cod})<br>
        Sugestões abaixo são apenas do nosso catálogo.
      `;
      resultadoVinhoEntrada.appendChild(topo);

      if (lista.length === 0) {
        const div = document.createElement("div");
        div.className = "status";
        div.textContent = "Nenhum outro vinho compatível encontrado.";
        resultadoVinhoEntrada.appendChild(div);
        return;
      }

      renderVinhos(lista, "wine bringing", resultadoVinhoEntrada);
    }
  </script>
</body>
</html>
