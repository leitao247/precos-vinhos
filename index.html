<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo S&P — Vinhos e Harmonizador</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.4}
    body{max-width:1200px;margin:20px auto;padding:18px;background:#f6f7fb;color:#111}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,button{padding:8px;border:1px solid #d1d5db;border-radius:6px}
    .families{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:18px}
    .family{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(16,24,40,.06);display:flex;flex-direction:column;gap:10px}
    .family .img{height:160px;background:#f3f4f6;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .family .img img{width:100%;height:100%;object-fit:cover}
    .family h2{margin:0;font-size:1rem;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .list{margin:0;padding:0;list-style:none;max-height:260px;overflow:auto}
    .list li{padding:6px 0;border-bottom:1px solid #f1f5f9;font-size:0.95rem}
    .muted{color:#6b7280;font-size:0.9rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:18px}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(16,24,40,.06)}
    .thumb{height:160px;background:#f3f4f6;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    pre{background:#0f172a;color:#fff;padding:12px;border-radius:6px;overflow:auto;max-height:320px}
    footer{margin-top:18px;color:#6b7280;font-size:0.9rem}
    .badge{background:#eef2ff;color:#1e3a8a;padding:4px 8px;border-radius:999px;font-weight:600}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Catálogo S&P — Vinhos e Harmonizador</h1>
      <div class="muted">Exibe nomes por família; imagens em <code>images/</code>. Harmonizador usa TheMealDB (chave pública).</div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Pesquisar por nome de vinho" style="width:300px" />
      <select id="filterFamily"><option value="">Todas as famílias</option></select>
      <button id="btnShowAll">Mostrar Todos</button>
    </div>
  </header>

  <section id="info" style="margin-top:12px;background:#fff;padding:10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.04)">
    <strong>Total de rótulos:</strong> <span id="totalCount">0</span>
    &nbsp;•&nbsp;
    <strong>Famílias:</strong> <span id="familyCount">0</span>
  </section>

  <main>
    <section id="families" class="families" aria-live="polite"></section>
  </main>

  <hr style="margin:18px 0" />

  <section style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
    <div style="flex:1;min-width:320px">
      <h2 style="margin:0 0 8px">Harmonizador rápido (TheMealDB)</h2>
      <div class="muted" style="margin-bottom:8px">Selecione um rótulo e clique em Buscar Top 3. Se não houver resultado por nome, usa categoria Seafood.</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="wineSelect" style="flex:1"></select>
        <button id="btnSearch">Buscar Top 3</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnRandom">Buscar Aleatório (3)</button>
        <button id="btnShowSaved">Ver Salvos</button>
        <button id="btnExport">Exportar Salvos</button>
        <button id="btnClearSaved" style="background:#fff;border:1px solid #f87171;color:#b91c1c">Limpar Salvos</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>

    <div style="flex:1;min-width:320px">
      <strong>Dados salvos (preview)</strong>
      <pre id="savedPreview">Nenhum item salvo.</pre>
    </div>
  </section>

  <main id="results" class="grid" aria-live="polite" style="margin-top:14px"></main>

  <footer>
    <div class="muted">Se quiser que eu gere a lista de nomes de arquivo sugeridos para as imagens (ex.: <code>Porta_6.jpg</code>), eu preparo.</div>
  </footer>

  <script>
    /************************************************************************
     * Dados completos: lista de rótulos (code, product, family)
     * (Este array foi extraído da planilha; mantenha-o intacto)
     ************************************************************************/
    const PRODUCTS = [
      {"code":"3000211","product":"Gaggiarone Vitgni Giovani Tto - Croatina","family":"Gaggiarone"},
      {"code":"3000420","product":"Gaggiarone Vitgni Giovani Tto - Croatina","family":"Gaggiarone"},
      {"code":"208","product":"Ca Montebello Tto DOC - Pinot Nero","family":"Ca Montebello"},
      {"code":"284","product":"Ca Montebello Bco DOC - Pinot Nero Bianco","family":"Ca Montebello"},
      {"code":"3000209","product":"Ca Montebello Bco IGT - Pinot Grigio","family":"Ca Montebello"},
      {"code":"3000210","product":"Ca Montebello Tto DOC - Barbera, Uva Rara","family":"Ca Montebello"},
      {"code":"290","product":"Neroperso Rosso Veneto IGT - Apassimento","family":"Neroperso"},
      {"code":"3000291","product":"Liburna DOC Sicilia Tto - Nero d'Avola","family":"Liburna"},
      {"code":"3000288","product":"Borgo del Filari DOC d'Abruzzo - Montepulciano","family":"Borgo del Filari"},
      {"code":"355","product":"La Fogliata di Puglia - Primitivo","family":"La Fogliata"},
      {"code":"3000388","product":"Torre Romanica - Rosso","family":"Torre Romanica"},
      {"code":"405","product":"Torre Romanica - Bianco","family":"Torre Romanica"},
      {"code":"3000405","product":"Torre Romanica - Bianco","family":"Torre Romanica"},
      {"code":"422","product":"Torre Romanica - Rosato","family":"Torre Romanica"},
      {"code":"3000422","product":"Torre Romanica - Rosato","family":"Torre Romanica"},
      {"code":"3000406","product":"Torre Romanica Tto - Sangiovese","family":"Torre Romanica"},
      {"code":"3000428","product":"Torre Romanica Pinot Grigio","family":"Torre Romanica"},
      {"code":"3000389","product":"Torre Romanica Puglia - Primitivo","family":"Torre Romanica"},
      {"code":"397","product":"Torre Romanica Premium - Montepulciano","family":"Torre Romanica"},
      {"code":"413","product":"Le Cime Passito IGT – Garganega, Moscato Amarelo","family":"Le Cime"},
      {"code":"412","product":"Carpino Garda DOC – Merlot","family":"Carpino"},
      {"code":"216","product":"Ribó Garda DOC - Cabernet Franc, Cabernet Sauvignon","family":"Ribó"},
      {"code":"415","product":"Meridiano Garda DOC – Chardonnay","family":"Meridiano"},
      {"code":"414","product":"Lugana DOC – Turbiana","family":"Lugana"},
      {"code":"408","product":"Cornalino Rosso IGT Alto Mincio – Merlot, Cabernet","family":"Cornalino"},
      {"code":"407","product":"I Ciottoli Garda DOC – Cabernet Franc, Cab. Sauvignon","family":"I Ciottoli"},
      {"code":"411","product":"Le Mure Garda DOC – Chardonnay","family":"Le Mure"},
      {"code":"215","product":"Mandorlo Bianco IGT Mantova – Tocai Friulano","family":"Mandorlo"},
      {"code":"410","product":"La Casina Bianco Garda DOC – Garganega, Trebbiano, Chardonnay","family":"La Casina"},
      {"code":"214","product":"La Casina Chiaretto Garda DOC – Merlot, Cabernet, Rondinella","family":"La Casina"},
      {"code":"409","product":"La Casina Rosso Garda DOC – Merlot, Rondinella, Cab. Sauvignon, Sangiovese","family":"La Casina"},
      {"code":"3000221","product":"Dirty Rabbit Tto - Petit Verdot","family":"Rabbit"},
      {"code":"220","product":"Charming Rabbit Bco - Chardonnay","family":"Rabbit"},
      {"code":"3000222","product":"Mrs. Rabbit Tto - Pinot Noir","family":"Rabbit"},
      {"code":"245","product":"Pink Rabbit Rosé - Grenache, Syrah","family":"Rabbit"},
      {"code":"223","product":"Mr. Rabbit Tto - Cabernet Sauvignon","family":"Rabbit"},
      {"code":"224","product":"Master Rabbit Tto - Syrah","family":"Rabbit"},
      {"code":"272","product":"Spring Rabbit Bco - Sauvignon Blanc","family":"Rabbit"},
      {"code":"225","product":"Chatelain Valmont Cotes du Rhone Tto - Grenache Syrah","family":"Chatelain"},
      {"code":"3000444","product":"Pescada Branco, DOC Verde","family":"Pescada"},
      {"code":"3000467","product":"Pescada Rosé, DOC Verde","family":"Pescada"},
      {"code":"445","product":"Pescada - Arinto e Trajadura","family":"Pescada"},
      {"code":"446","product":"Pescada - 100% Alvarinho","family":"Pescada"},
      {"code":"171","product":"Porta 6 Tto meia garrafa","family":"Porta 6"},
      {"code":"172","product":"Porta 6 Bco meia garrafa","family":"Porta 6"},
      {"code":"130","product":"Espumante Porta 6 Bco Brut","family":"Porta 6"},
      {"code":"160","product":"Vinho Verde Porta 6 DOC","family":"Porta 6"},
      {"code":"3000160","product":"Vinho Verde Porta 6 DOC","family":"Porta 6"},
      {"code":"931","product":"Porta 6 Bco","family":"Porta 6"},
      {"code":"300093","product":"Porta 6 Bco","family":"Porta 6"},
      {"code":"185","product":"Porta 6 Rosé","family":"Porta 6"},
      {"code":"300078","product":"Porta 6 Tto","family":"Porta 6"},
      {"code":"170","product":"Porta 6 Reserva Tto","family":"Porta 6"},
      {"code":"3000157","product":"Porta 6 Magnum Tto","family":"Porta 6"},
      {"code":"3000250","product":"Porta 6 Double Magnum Tto","family":"Porta 6"},
      {"code":"3000173","product":"Bag in Box Porta 6 Tto","family":"Porta 6"},
      {"code":"3000466","product":"Bag in Box Porta 6 Bco","family":"Porta 6"},
      {"code":"3000296","product":"Pack 2un - Porta 6 Tto","family":"Porta 6"},
      {"code":"3000400","product":"Pack 2un - (1 Porta 6 Tto 1 Porta 6 Bco)","family":"Porta 6"},
      {"code":"3000348","product":"Porta 6 Bitube Tto","family":"Porta 6"},
      {"code":"110","product":"Dom Dinis Reserva Tto","family":"Dom Dinis"},
      {"code":"161","product":"Dom Dinis Mesa Bco","family":"Dom Dinis"},
      {"code":"39","product":"Reserva dos Amigos Tinto","family":"Reserva dos Amigos"},
      {"code":"83","product":"Reserva dos Amigos Magnum Tto","family":"Reserva dos Amigos"},
      {"code":"162","product":"Reserva dos Amigos Seleção Especial Tto","family":"Reserva dos Amigos"},
      {"code":"3000163","product":"Bag in Box Branco dos Amigos","family":"Reserva dos Amigos"},
      {"code":"97","product":"Bag in Box Tinto dos Amigos","family":"Reserva dos Amigos"},
      {"code":"120","product":"3 Autores Verde DOC Branco","family":"3 Autores"},
      {"code":"96","product":"3 Autores Douro DOC Tinto","family":"3 Autores"},
      {"code":"246","product":"3 Autores Douro DOC Branco","family":"3 Autores"},
      {"code":"114","product":"3 Autores Grande Reserva Tto","family":"3 Autores"},
      {"code":"3000116","product":"Coragem Superior Tto","family":"Coragem"},
      {"code":"115","product":"Coragem Superior Bco","family":"Coragem"},
      {"code":"178","product":"Coragem Reserva Tto","family":"Coragem"},
      {"code":"180","product":"Coragem Regional Lisboa Tto","family":"Coragem"},
      {"code":"111","product":"N.B.N.C No Branding No Cry Tto (Vidigal)","family":"Vidigal"},
      {"code":"300046","product":"Brutalis by Vidigal Tto","family":"Vidigal"},
      {"code":"3000297","product":"Brutalis by Vidigal Tto","family":"Vidigal"},
      {"code":"41","product":"Vidigal Reserva Tto","family":"Vidigal"},
      {"code":"300043","product":"Vidigal Single Grape Tto - Touriga Nacional","family":"Vidigal"},
      {"code":"159","product":"Vidigal Chapeu de Praia Rosé","family":"Vidigal"},
      {"code":"326","product":"Zé do Telhado DOC Douro","family":"Vidigal"},
      {"code":"333","product":"Boa Noite Lisboa Tinto","family":"Boa Noite Lisboa"},
      {"code":"334","product":"Boa Noite Lisboa Branco","family":"Boa Noite Lisboa"},
      {"code":"344","product":"Boa Noite Lisboa Rosé","family":"Boa Noite Lisboa"},
      {"code":"3000154","product":"Júlia Florista Tto","family":"Júlia Florista"},
      {"code":"3000181","product":"Júlia Florista Bco","family":"Júlia Florista"},
      {"code":"3000346","product":"Júlia Florista Rosé","family":"Júlia Florista"},
      {"code":"3000345","product":"Júlia Florista Reserva Tto","family":"Júlia Florista"},
      {"code":"3000196","product":"Bag in Box Júlia Florista Bco","family":"Júlia Florista"},
      {"code":"3000179","product":"Bag in Box Júlia Florista Tto","family":"Júlia Florista"},
      {"code":"347","product":"Júlia Florista Bitube Tto","family":"Júlia Florista"},
      {"code":"232","product":"Artolas Reserva Tto","family":"Artolas"},
      {"code":"153","product":"Artolas Tinto","family":"Artolas"},
      {"code":"158","product":"Artolas Branco","family":"Artolas"},
      {"code":"3000233","product":"Artolas Rosé","family":"Artolas"},
      {"code":"90","product":"Da Pipa Branco","family":"Da Pipa"},
      {"code":"3000273","product":"Da Pipa Tinto","family":"Da Pipa"},
      {"code":"298","product":"Da Pipa Rosé","family":"Da Pipa"},
      {"code":"241","product":"Da Pipa Branco","family":"Da Pipa"},
      {"code":"247","product":"Da Pipa Rosé","family":"Da Pipa"},
      {"code":"3000242","product":"Da Pipa Tinto","family":"Da Pipa"},
      {"code":"358","product":"Da Pipa Frisante Branco","family":"Da Pipa"},
      {"code":"359","product":"Da Pipa Frisante Rosé","family":"Da Pipa"},
      {"code":"356","product":"Da Pipa Espumante Branco (Blanc de Blancs)","family":"Da Pipa"},
      {"code":"357","product":"Da Pipa Espumante Rosé","family":"Da Pipa"},
      {"code":"3000243","product":"Da Pipa Bag in Box Bco","family":"Da Pipa"},
      {"code":"3000248","product":"Da Pipa Bag in Box Rosé","family":"Da Pipa"},
      {"code":"3000244","product":"Da Pipa Bag in Box Tto","family":"Da Pipa"},
      {"code":"266","product":"Da Pipa Reserva IG Bco","family":"Da Pipa"},
      {"code":"3000267","product":"Da Pipa Reserva IG Tto","family":"Da Pipa"},
      {"code":"3000268","product":"Da Pipa Colheita Selecionada Tto","family":"Da Pipa"},
      {"code":"270","product":"Da Pipa Signature Bco","family":"Da Pipa"},
      {"code":"3000314","product":"Fonte da Perdiz Reserva Tinto - Douro DOC","family":"Fonte da Perdiz"},
      {"code":"3000317","product":"Fonte da Perdiz Tinto - Douro DOC","family":"Fonte da Perdiz"},
      {"code":"3000315","product":"Fonte da Perdiz Branco - Douro DOC","family":"Fonte da Perdiz"},
      {"code":"3000427","product":"Fonte da Perdiz Superior Tinto","family":"Fonte da Perdiz"},
      {"code":"3000327","product":"Intimista Tinto","family":"Amareleza"},
      {"code":"3000343","product":"Intimista Branco","family":"Amareleza"},
      {"code":"3000310","product":"Intimista Rosé","family":"Amareleza"},
      {"code":"3000299","product":"Eruptio Blend Açores D.O Pico","family":"Eruptio"},
      {"code":"3000300","product":"Eruptio Arinto D.O Pico","family":"Eruptio"},
      {"code":"3000301","product":"Eruptio Verdelho D.O Pico","family":"Eruptio"},
      {"code":"3000354","product":"Moscatel do Douro - Martha's","family":"Martha's"},
      {"code":"3000350","product":"Porto White - Martha's","family":"Martha's"},
      {"code":"3000351","product":"Porto Ruby - Martha's","family":"Martha's"},
      {"code":"3000423","product":"Porto Rosé - Martha's","family":"Martha's"},
      {"code":"353","product":"Porto 10 anos - Martha's","family":"Martha's"},
      {"code":"423","product":"Porto 20 anos - Martha's","family":"Martha's"},
      {"code":"3000360","product":"Isla Negra Reserva - Cabernet Sauvignon","family":"Isla Negra"},
      {"code":"3000361","product":"Isla Negra Reserva - Carmenere","family":"Isla Negra"},
      {"code":"3000362","product":"Isla Negra Reserva - Merlot","family":"Isla Negra"},
      {"code":"3000363","product":"Isla Negra Reserva - Sauvignon Blanc","family":"Isla Negra"},
      {"code":"3000263","product":"New Roads Tto - Malbec, Tempranillo, Bonarda","family":"New Roads"},
      {"code":"3000271","product":"New Roads Bco - Ugni Blanc, Chenin, Pedro Gimenez","family":"New Roads"},
      {"code":"456","product":"New Roads Tto - Malbec 100%","family":"New Roads"},
      {"code":"382","product":"Viñas del Tango Rosé","family":"Viñas del Tango"},
      {"code":"381","product":"Viñas del Tango Varietal - Chardonnay","family":"Viñas del Tango"},
      {"code":"3000404","product":"Viñas del Tango Varietal - Torrontes","family":"Viñas del Tango"},
      {"code":"3000402","product":"Viñas del Tango Varietal - Cabernet Franc","family":"Viñas del Tango"},
      {"code":"403","product":"Viñas del Tango Varietal - Cabernet Sauvignon","family":"Viñas del Tango"},
      {"code":"3000403","product":"Viñas del Tango Varietal - Cabernet Sauvignon","family":"Viñas del Tango"},
      {"code":"383","product":"Viñas del Tango Varietal - Malbec","family":"Viñas del Tango"},
      {"code":"3000383","product":"Viñas del Tango Varietal - Malbec","family":"Viñas del Tango"},
      {"code":"385","product":"Viñas del Tango Gran - Malbec","family":"Viñas del Tango"},
      {"code":"3000385","product":"Viñas del Tango Selection - Malbec","family":"Viñas del Tango"},
      {"code":"3000387","product":"Viñas del Tango Selection - Cabernet Sauvignon","family":"Viñas del Tango"},
      {"code":"452","product":"Viñas del Tango Malbec Premium","family":"Viñas del Tango"},
      {"code":"3000452","product":"Viñas del Tango Malbec Premium","family":"Viñas del Tango"},
      {"code":"3000191","product":"Cava Bonaval Brut Rosé - Garnacha","family":"Cava Bonaval"},
      {"code":"3000192","product":"Cava Bonaval Brut Branco - Macabeo","family":"Cava Bonaval"},
      {"code":"3000468","product":"Cava Bonaval Branca Brut Sleeve","family":"Cava Bonaval"},
      {"code":"3000251","product":"La Vache Espagnole Tto - Tempranillo, Monastrell","family":"La Vache"},
      {"code":"3000269","product":"La Vache Espagnole Bco - Macabeo","family":"La Vache"},
      {"code":"3000492","product":"Vinho Vidigal Rosé (6x750ml)","family":"Marques de Vitoria / Vidigal"},
      {"code":"3000491","product":"Vinho Prado Molar Tinto (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000490","product":"Vinho Marques de Vitoria Joven (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000489","product":"Vinho Marques de Vitoria Rosé (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000488","product":"Vinho Marques de Vitoria Blanco (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000487","product":"Vinho Marques de Vitoria Crianza (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000486","product":"Vinho Marques de Vitoria Reserva (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000485","product":"Vinho Marques de Vitoria Gran Reserva (6x750ml)","family":"Marques de Vitoria"},
      {"code":"3000476","product":"Vinho S.A Tto Stormhoek Pure Shiraz","family":"Stormhoek"},
      {"code":"3000475","product":"Vinho S.A Tto Stormhoek Cabernet/Merlot","family":"Stormhoek"},
      {"code":"3000474","product":"Vinho S.A Tto Stormhoek Syrah","family":"Stormhoek"},
      {"code":"3000473","product":"Vinho S.A Bco Stormhoek Sauvignon Blanc","family":"Stormhoek"},
      {"code":"3000472","product":"Vinho S.A Tto Stormhoek Pinotage","family":"Stormhoek"},
      {"code":"3000471","product":"Vinho S.A Tto Stormhoek Pinotage/Malbec","family":"Stormhoek"},
      {"code":"3000470","product":"Vinho S.A Bco Stormhoek Pinot Grigio","family":"Stormhoek"},
      {"code":"3000469","product":"Vinho S.A Bco Stormhoek Chard./Viognier","family":"Stormhoek"}
    ];

    /************************************************************************
     * Utilitários e renderização (corrigidos para evitar erros comuns)
     ************************************************************************/

    // escape HTML
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // remove acentos e normaliza para nome de arquivo
    function normalizeFilename(name){
      if(!name) return '';
      // remove diacríticos
      const noDiacritics = name.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      // replace spaces and slashes with underscore, remove problematic chars
      return noDiacritics.replace(/[\/\\]+/g,'_').replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-\.]/g,'').trim();
    }

    // tenta várias variações de nome de arquivo (cru, underscore, normalized)
    function candidateImagePaths(family){
      const raw = `images/${family}.jpg`;
      const rawPng = `images/${family}.png`;
      const unders = `images/${family.replace(/\s+/g,'_')}.jpg`;
      const undersPng = `images/${family.replace(/\s+/g,'_')}.png`;
      const norm = `images/${normalizeFilename(family)}.jpg`;
      const normPng = `images/${normalizeFilename(family)}.png`;
      return [raw, rawPng, unders, undersPng, norm, normPng];
    }

    // cria elemento img que tenta as variações em sequência
    function createImgWithFallback(family){
      const img = document.createElement('img');
      img.alt = family;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      const candidates = candidateImagePaths(family);
      let idx = 0;
      img.src = candidates[idx];
      img.onerror = function(){
        idx++;
        if(idx < candidates.length){
          img.src = candidates[idx];
        } else {
          img.onerror = null;
          img.src = placeholderDataUrl();
        }
      };
      return img;
    }

    function placeholderDataUrl(){
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="20">Imagem não disponível</text></svg>`
      );
    }

    // agrupa por família
    function groupByFamily(items){
      const map = new Map();
      for(const p of items){
        const fam = (p.family || 'Outros').trim();
        if(!map.has(fam)) map.set(fam, []);
        map.get(fam).push(p);
      }
      return map;
    }

    // cria cartão de família (usa createImgWithFallback)
    function createFamilyCard(family, items){
      const section = document.createElement('section');
      section.className = 'family';
      const imgWrap = document.createElement('div');
      imgWrap.className = 'img';
      imgWrap.appendChild(createImgWithFallback(family));
      const h = document.createElement('h2');
      h.innerHTML = `${escapeHtml(family)} <span class="muted">(${items.length})</span>`;
      const ul = document.createElement('ul');
      ul.className = 'list';
      for(const it of items){
        const li = document.createElement('li');
        li.textContent = it.product;
        ul.appendChild(li);
      }
      section.appendChild(imgWrap);
      section.appendChild(h);
      section.appendChild(ul);
      return section;
    }

    // render principal
    const familiesEl = document.getElementById('families');
    const filterFamily = document.getElementById('filterFamily');
    const searchInput = document.getElementById('search');
    const totalCountEl = document.getElementById('totalCount');
    const familyCountEl = document.getElementById('familyCount');
    const btnShowAll = document.getElementById('btnShowAll');

    let grouped;
    function populateFilter(){
      grouped = groupByFamily(PRODUCTS);
      const families = Array.from(grouped.keys()).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      filterFamily.innerHTML = '<option value="">Todas as famílias</option>';
      for(const f of families){
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        filterFamily.appendChild(opt);
      }
      familyCountEl.textContent = families.length;
    }

    function renderAll(selectedFamily = '', q = ''){
      familiesEl.innerHTML = '';
      const families = Array.from(grouped.keys()).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      let shown = 0;
      for(const fam of families){
        if(selectedFamily && fam !== selectedFamily) continue;
        const items = grouped.get(fam).filter(p => !q || p.product.toLowerCase().includes(q));
        if(items.length === 0) continue;
        familiesEl.appendChild(createFamilyCard(fam, items));
        shown += items.length;
      }
      totalCountEl.textContent = shown;
      console.log('Renderizado', shown, 'rótulos (filtro:', selectedFamily || 'todas', 'pesquisa:', q || '—', ')');
    }

    filterFamily.addEventListener('change', ()=> renderAll(filterFamily.value, searchInput.value.trim().toLowerCase()));
    searchInput.addEventListener('input', ()=> renderAll(filterFamily.value, searchInput.value.trim().toLowerCase()));
    btnShowAll.addEventListener('click', ()=> { filterFamily.value = ''; searchInput.value = ''; renderAll(); });

    // inicialização segura
    (function initCatalog(){
      try{
        if(!Array.isArray(PRODUCTS)) throw new Error('PRODUCTS não é um array.');
        populateFilter();
        renderAll();
        console.log('PRODUCTS length =', PRODUCTS.length);
      } catch(err){
        console.error('Erro inicializando catálogo:', err);
        familiesEl.innerHTML = '<div class="muted">Erro ao carregar catálogo. Veja console para detalhes.</div>';
      }
    })();

    /************************************************************************
     * Harmonizador (TheMealDB) + salvamento local (localStorage)
     ************************************************************************/
    const WINES = Array.from(new Set(PRODUCTS.map(p => p.product))).slice(0, 200); // lista de rótulos (evita duplicatas)
    const wineSelect = document.getElementById('wineSelect');
    const btnSearch = document.getElementById('btnSearch');
    const btnRandom = document.getElementById('btnRandom');
    const btnShowSaved = document.getElementById('btnShowSaved');
    const btnExport = document.getElementById('btnExport');
    const btnClearSaved = document.getElementById('btnClearSaved');
    const results = document.getElementById('results');
    const status = document.getElementById('status');
    const savedPreview = document.getElementById('savedPreview');

    // preencher select de vinhos
    (function populateWines(){
      wineSelect.innerHTML = '<option value="">— selecione um rótulo (ou deixe em branco para aleatório) —</option>';
      for(const w of WINES){
        const o = document.createElement('option');
        o.value = w;
        o.textContent = w;
        wineSelect.appendChild(o);
      }
    })();

    const API_KEY = '1';
    const BASE = `https://www.themealdb.com/api/json/v1/${API_KEY}`;
    const STORAGE_KEY = 'harmonizador_salvos_v1';

    function readSaved(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      } catch(e){
        console.error('Erro lendo storage', e);
        return [];
      }
    }
    function saveItem(item){
      const arr = readSaved();
      if(item.idMeal && arr.some(x => x.idMeal === item.idMeal)) return false;
      arr.push(item);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      return true;
    }
    function clearSaved(){
      localStorage.removeItem(STORAGE_KEY);
    }
    function updateSavedPreview(){
      const arr = readSaved();
      savedPreview.textContent = arr.length ? JSON.stringify(arr, null, 2) : 'Nenhum item salvo.';
    }

    async function fetchJson(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('Erro na requisição: ' + res.status);
      return res.json();
    }

    async function searchByName(q){
      const url = `${BASE}/search.php?s=${encodeURIComponent(q)}`;
      status.textContent = 'Buscando por nome: ' + q + ' ...';
      const json = await fetchJson(url);
      return json.meals;
    }

    async function filterByCategory(cat){
      const url = `${BASE}/filter.php?c=${encodeURIComponent(cat)}`;
      status.textContent = 'Fallback: buscando por categoria: ' + cat + ' ...';
      const json = await fetchJson(url);
      return json.meals;
    }

    async function lookupById(id){
      const url = `${BASE}/lookup.php?i=${encodeURIComponent(id)}`;
      const json = await fetchJson(url);
      return json.meals ? json.meals[0] : null;
    }

    function createMealCard(meal, showSave=true){
      const div = document.createElement('div');
      div.className = 'card';
      const thumb = meal.strMealThumb || '';
      const name = meal.strMeal || '—';
      const id = meal.idMeal || '';
      const source = meal.strSource || meal.strYoutube || '#';
      div.innerHTML = `
        <div class="thumb"><img src="${thumb}" alt="${escapeHtml(name)}" onerror="this.src='${placeholderDataUrl()}'" /></div>
        <h3 style="margin:8px 0 6px">${escapeHtml(name)}</h3>
        <div class="muted small">ID: ${escapeHtml(id)}</div>
        <div class="actions">
          <a class="badge" href="${source || '#'}" target="_blank" rel="noopener">Abrir receita</a>
          ${ showSave ? '<button class="btnSave" style="padding:6px 10px;border-radius:6px">Salvar</button>' : '' }
        </div>
      `;
      if(showSave){
        const btn = div.querySelector('.btnSave');
        btn.addEventListener('click', ()=>{
          const ok = saveItem(meal);
          status.textContent = ok ? 'Receita salva.' : 'Receita já estava salva.';
          updateSavedPreview();
        });
      }
      return div;
    }

    function pickTopN(arr, n=3){ if(!Array.isArray(arr)) return []; return arr.slice(0,n); }

    async function findTop3ForWine(wineName){
      results.innerHTML = '';
      try{
        status.textContent = 'Iniciando busca...';
        if(wineName){
          const byName = await searchByName(wineName);
          if(byName && byName.length){
            status.textContent = `Encontradas ${byName.length} receitas por nome. Exibindo top 3.`;
            const top = pickTopN(byName, 3);
            for(const m of top) results.appendChild(createMealCard(m, true));
            return;
          }
        }

        const cat = 'Seafood';
        const byCat = await filterByCategory(cat);
        if(byCat && byCat.length){
          status.textContent = `Nenhuma receita por nome. Usando categoria "${cat}". Exibindo top 3.`;
          const top = pickTopN(byCat, 3);
          for(const item of top){
            const full = await lookupById(item.idMeal);
            results.appendChild(createMealCard(full || item, true));
          }
          return;
        }

        status.textContent = 'Nenhum prato encontrado; buscando aleatório...';
        const r = await fetch(`${BASE}/random.php`);
        const j = await r.json();
        if(j.meals && j.meals.length){
          status.textContent = 'Exibindo sugestão aleatória.';
          results.appendChild(createMealCard(j.meals[0], true));
          return;
        }

        status.textContent = 'Nenhum prato encontrado.';
      } catch(err){
        console.error(err);
        status.textContent = 'Erro ao buscar: ' + (err.message || err);
      }
    }

    // eventos harmonizador
    btnSearch.addEventListener('click', ()=> {
      const wine = wineSelect.value.trim();
      findTop3ForWine(wine);
    });

    btnRandom.addEventListener('click', async ()=>{
      results.innerHTML = '';
      status.textContent = 'Buscando 3 receitas aleatórias...';
      try{
        for(let i=0;i<3;i++){
          const r = await fetch(`${BASE}/random.php`);
          const j = await r.json();
          if(j.meals && j.meals[0]) results.appendChild(createMealCard(j.meals[0], true));
        }
        status.textContent = 'Pronto — 3 receitas aleatórias.';
      } catch(e){
        console.error(e);
        status.textContent = 'Erro ao buscar aleatórias.';
      }
    });

    btnShowSaved.addEventListener('click', ()=>{
      const arr = readSaved();
      results.innerHTML = '';
      if(arr.length === 0){
        status.textContent = 'Nenhuma receita salva.';
        savedPreview.textContent = 'Nenhum item salvo.';
        return;
      }
      status.textContent = `Mostrando ${arr.length} receitas salvas.`;
      for(const m of arr) results.appendChild(createMealCard(m, false));
      savedPreview.textContent = JSON.stringify(arr, null, 2);
    });

    btnExport.addEventListener('click', ()=>{
      const arr = readSaved();
      const dataStr = JSON.stringify(arr, null, 2);
      const w = window.open('', '_blank');
      w.document.write('<pre>' + escapeHtml(dataStr) + '</pre>');
      w.document.title = 'Export JSON - Receitas Salvas';
    });

    btnClearSaved.addEventListener('click', ()=>{
      if(!confirm('Deseja realmente limpar todas as receitas salvas?')) return;
      clearSaved();
      updateSavedPreview();
      results.innerHTML = '';
      status.textContent = 'Salvos limpos.';
    });

    // inicial harmonizador
    (function initHarmonizador(){
      wineSelect.selectedIndex = 0;
      updateSavedPreview();
      status.textContent = 'Pronto. Selecione um rótulo e clique em Buscar Top 3.';
    })();

    // expor para depuração
    window.PRODUCTS = PRODUCTS;
    window.normalizeFilename = normalizeFilename;
  </script>
</body>
</html>
